name: Build and Release
on:
  push:
    tags:
      - 'v*'
# Grant write permission to create releases
permissions:
  contents: write
jobs:
  build:
    name: Build and Release
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Download AutoHotkey v2 and Compiler
        shell: powershell
        run: |
          # 1. Download AutoHotkey v2 (The Engine)
          Write-Host "Fetching latest AutoHotkey v2..."
          $ahkRelease = Invoke-RestMethod -Uri "https://api.github.com/repos/AutoHotkey/AutoHotkey/releases/latest"
          $ahkUrl = $ahkRelease.assets | Where-Object { $_.name -like "*.zip" } | Select-Object -ExpandProperty browser_download_url -First 1
          Invoke-WebRequest -Uri $ahkUrl -OutFile "AutoHotkey.zip"
          Expand-Archive -Path "AutoHotkey.zip" -DestinationPath "AHK_v2"
          
          # 2. Download Ahk2Exe (The Compiler)
          Write-Host "Fetching latest Ahk2Exe..."
          $compilerRelease = Invoke-RestMethod -Uri "https://api.github.com/repos/AutoHotkey/Ahk2Exe/releases/latest"
          $compilerUrl = $compilerRelease.assets | Where-Object { $_.name -like "*.zip" } | Select-Object -ExpandProperty browser_download_url -First 1
          Invoke-WebRequest -Uri $compilerUrl -OutFile "Ahk2Exe.zip"
          Expand-Archive -Path "Ahk2Exe.zip" -DestinationPath "Compiler"
          Write-Host "Tools prepared successfully."
      - name: Compile LangConvert Application
        shell: powershell
        run: |
          $baseFile = "AHK_v2\AutoHotkey64.exe"
          $compiler = "Compiler\Ahk2Exe.exe"
          
          # Run Compiler
          & $compiler /in "langover.ahk" /out "langover.exe" /icon "FinalGreen.ico" /base $baseFile
      
      - name: Compile Setup Script
        shell: powershell
        run: |
          $baseFile = "AHK_v2\AutoHotkey64.exe"
          $compiler = "Compiler\Ahk2Exe.exe"
          
          # Run Compiler
          & $compiler /in "Setup.ahk" /out "Setup.exe" /icon "FinalGreen.ico" /base $baseFile
      
      - name: Verify Output
        shell: powershell
        run: |
           if (!(Test-Path "langover.exe")) { throw "Error: langover.exe was not created." }
           if (!(Test-Path "Setup.exe")) { throw "Error: Setup.exe was not created." }
           Write-Host "Build verified."
      - name: Create Zip Archive
        run: |
          Compress-Archive -Path "Setup.exe", "langover.exe", "DiscountLogo.png", "FinalGreen.ico", "FinalRed.ico", "README.md" -DestinationPath "LangConvert_Install.zip"
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            LangConvert_Install.zip
            Setup.exe
            langover.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
